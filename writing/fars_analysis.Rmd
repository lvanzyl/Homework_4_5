---
title: "fars_analysis"
author: "Lizette van Zyl"
date: "October 25, 2017"
output: word_document
---
```{r}
library(tidyverse)
library(ggplot2)
```

```{r}
# table of clean-fars data

clean_fars %>%
  mutate(year_cat = cut(year, breaks = c(1999, 2002, 2006, 2010),
                        labels = c("1999-2002", "2003-2006",
                                   "2007-2010"),
                        include.lowest = TRUE, right = TRUE)) %>%
  filter(!is.na(sex)) %>%
  group_by(drug_type, sex, year_cat) %>%
  summarize(n_non_missing = sum(!is.na(positive_for_drug)),
            positive_test = sum(positive_for_drug, na.rm = TRUE),
            perc_positive = round(100 * positive_test / n_non_missing, 1)) %>%
  select(drug_type, sex, year_cat, perc_positive) %>%
  unite(sex_year_cat, sex, year_cat) %>%
  spread(sex_year_cat, perc_positive) %>%
  knitr::kable(col.names = c("Drug type", "F 1999-2002",
                             "F 2003-2006", "F 2007-2010",
                             "M 1999-2002", "M 2003-2006",
                             "M 2007-2010"))
```

```{r}
fars_nums <- clean_fars %>%
             filter(!as.character(drug_type) %in% "Alcohol") %>%
             group_by(year) %>%
             distinct(unique_id) %>%
             summarise(num_in_year = n())

fars_for_plot <- left_join(clean_fars, fars_nums, by = "year") %>%
                 filter(agecat != is.na(agecat),
                        #drug_type != "Alcohol",
                        positive_for_drug == TRUE) %>%
                 group_by(agecat, year)

fars_for_plot <- summarise(fars_for_plot, number_drugs = n())

fars_for_plot <- left_join(fars_for_plot, fars_nums, by = "year")
fars_for_plot <- mutate(fars_for_plot, percentage_drugs = number_drugs/num_in_year *100)

ggplot(fars_for_plot, aes(x = year, y = percentage_drugs, shape = agecat)) +
  geom_point()
```

